---
title: "zooplankton_ice"
author: "Christopher Rounds"
date: "2/1/2024"
output: html_document
---

```{r setup}
library(tidyverse)
library(mnsentinellakes)
library(mgcv)
library(gratia)
library(mwlaxeref)
library(cowplot)
options(scipen = 999)


zoop <- read.csv("./data/ramsey_county_zooplankton.csv") 

# These are calulated from all of white bear ice data (not just post-1980)
early.anomaly = -17.52
late.anomaly = 14

```




# Combine ice data with zooplankton data
## Use ice data only from White Bear (DOW = 82016700)
```{r}
ice_off <- read.csv("./data/ice_off_summarized.csv") %>%
  mutate(DNRID = fixlakeid(DOW)) %>% 
  dplyr::select(DNRID, year, min_ice_off_julian, min_ice_off_date) %>%
  dplyr::filter(DNRID == "82016700")


mean_ice <- ice_off  %>%
  dplyr::filter(year < 1980) %>%
  summarise(mean_ice_off = mean(min_ice_off_julian))

# Negative values indicate earlier anomalies
wb.ice = ice_off %>%
  add_row(data.frame(year = 2024, min_ice_off_julian = 67, min_ice_off_date = "2024-03-08")) %>%
  mutate(ice_off_anomaly = min_ice_off_julian - mean_ice$mean_ice_off) %>% 
  select(!DNRID) %>% 
  filter(year > 1980)

temp <- merge(wb.ice, zoop, by = c("year")) %>% 
  mutate(days_since_ice = JULIANDAY - min_ice_off_julian) %>%
  dplyr::filter(!is.na(CYCLO.THOUS.M3)) %>%
  mutate(ice_off_anomaly = as.numeric(ice_off_anomaly),
         JULIANDAY = as.numeric(JULIANDAY),
         year = as.numeric(year),
         year_f = as.factor(year),
         DNRID = as.factor(DNRID), 
         ice_off_anomaly_abs = abs(ice_off_anomaly)) %>%
  # Subjective but remove early (pre-february) and late (post Decemeber) dates
  dplyr::filter(JULIANDAY > 60) %>%  
  dplyr::filter(JULIANDAY < 330) %>% 
  rowwise() %>%
  mutate('ZOOP.THOUS.M3' = sum(c_across(CYCLO.THOUS.M3:DIAPHAN.THOUS.M3))) %>% 
  select(year, min_ice_off_julian, min_ice_off_date, ice_off_anomaly, 
         DNRID, SITE, DATE, TOW, ZOOP.THOUS.M3, everything()) %>% ungroup() %>% as.data.frame()

sampling.events <- temp %>% group_by(DNRID, year) %>% count() #%>% filter(n > 200)
median(sampling.events$n)


```


# Run all GAMS
```{r}
# loops through columns 10-20 in the dataframe temp and runs nb GAMMs
# TO DO - Play with offsets and counts 
models <- list()

for (i in 10:18) { #10-18
  
  single.model <- gam(temp[,i] ~ s(ice_off_anomaly) +  
                      s(JULIANDAY) + 
                      ti(ice_off_anomaly, JULIANDAY) +
                      s(DNRID, bs = "re") + s(year_f, bs = "re"),
                    method = "REML", select = T,
                    data = temp, family = nb())
  print(paste0("Finished ", colnames(temp)[i]))
  models[[paste0(colnames(temp)[i])]] <- single.model
}

summary(models$CYCLO.THOUS.M3)
summary(models$CALA.THOUS.M3)
summary(models$NAUP.THOUS.M3)
summary(models$ROTIF.THOUS.M3)
summary(models$DAPH.THOUS.M3)
summary(models$BOSM.THOUS.M3)
summary(models$CHYD.THOUS.M3)
summary(models$CERIOD.THOUS.M3)


appraise(models$CYCLO.THOUS.M3)
appraise(models$CALA.THOUS.M3)
appraise(models$NAUP.THOUS.M3)
appraise(models$ROTIF.THOUS.M3)
appraise(models$DAPH.THOUS.M3)
appraise(models$BOSM.THOUS.M3)
appraise(models$CHYD.THOUS.M3)
appraise(models$CERIOD.THOUS.M3)

k.check(models$CYCLO.THOUS.M3)
k.check(models$CALA.THOUS.M3)
k.check(models$NAUP.THOUS.M3)
k.check(models$ROTIF.THOUS.M3)
k.check(models$DAPH.THOUS.M3)
k.check(models$BOSM.THOUS.M3)
k.check(models$CHYD.THOUS.M3)
k.check(models$CERIOD.THOUS.M3)

#write_rds(models, "./models/zoop.models.rds")
```

# Read-in outputted models
```{r}
models <- read_rds("./models/zoop.models.rds")
```


# DOY change function
```{r}
plot.zoop.doy = function(model = NA, var.name = NA, type = "plot", slice = 1, y.label = NA, 
                         early.anomaly = -17.52, late.anomaly = 14, start.date = 80, end.date = 274) {
  if (is.na(model)) {
    model <- models[[var.name]]
  }
  # Year and DNRID aren't used but are required for predict.gam
  length <- length(seq(start.date, end.date, by = 1))
  pred.df <- data.frame(ice_off_anomaly_abs = 
                          c(rep(early.anomaly, length), rep(0, length), rep(late.anomaly, length)),
                        ice_off_anomaly = 
                          c(rep(early.anomaly, length), rep(0, length), rep(late.anomaly, length)),
                        JULIANDAY = seq(start.date, end.date, by = 1), 
                        DNRID = "62001200", year_f = "2000") 
  
  fit <- predict.gam(model, pred.df,
                     unconditional = T, # Gives simultaneous
                     type = "response",
                     exclude = c('s(DNRID)', 
                                's(year_f)'),
                     se.fit = T)
  pred.df$predictions = fit$fit
  pred.df$se = fit$se.fit
  
  if (type == "plot") {
    y.label <- species.labels %>% filter(variable == var.name) %>% 
        select(axis.label) %>% as.character()
    plot <- pred.df %>%
      mutate(ice_off_anomaly = as.factor(ice_off_anomaly),
             ice_off_f = 
               ifelse(ice_off_anomaly == early.anomaly, "Early", "Normal"),
             ice_off_f = 
               ifelse(ice_off_anomaly == late.anomaly, "Late", ice_off_f),
             ice_off_f = factor(ice_off_f, 
                                levels = c("Early", "Normal", "Late"))) %>%
      ggplot(aes(y = predictions, x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                                              color = ice_off_anomaly)) +
      geom_line(aes(y = predictions, x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                                                 color = ice_off_f), lwd = 2) +
      theme_classic() +
      scale_x_date(date_breaks = "months" , date_labels = "%b") + 
      scale_color_manual(values = c("#FF0000", "#000000", "#0000FF")) +
      labs(y = paste0(y.label), x = "Julian Day", 
           color = "Ice-Off", fill = "Ice-Off") +
      
      theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 16))
  
plot    
    
    return(plot)
  } # End plot if statement
  
  if (type == "max.date") {
    max.date <- pred.df %>% group_by(ice_off_anomaly) %>% slice_max(predictions, n = slice) %>% 
      mutate(zoop = var.name)
    max.date$predictions <- predict(model, newdata = max.date, 
                                    exclude = c("s(DNRID)", "s(year_f)"), 
                                    type = "response")
    max.date$se <- predict(model, newdata = max.date, exclude = c("s(DNRID)", "s(year_f)"), 
                           type = "response", se.fit = T)$se.fit
    
    return(max.date)
  } # End prediction if statement
}

```


# Plot DOY change - FIGURE S7
```{r}
hist(temp$JULIANDAY) # Approx 125-275 for peak sampling, look at 100 - 300
min(temp$JULIANDAY)

# Thoughts to do - Change x-axis to Months
species.labels <- data.frame(variable = c(names(models)), 
           axis.label = c("Cyclopoid Density", "Calanoid Density", 
                          "Nauplii Density", "Rotifer Density", 
                          "Daphnia Density", "Bosmina Density", 
                          "Chydoridae Density", "Ceriodaphnia Density", 
                          "Diaphanosoma Density"))


cyclo.doy <- plot.zoop.doy(var.name = "CYCLO.THOUS.M3") + theme(legend.position = "none")
#cyclo.doy 
cala.doy <- plot.zoop.doy(var.name = "CALA.THOUS.M3") + 
  theme(legend.position = "none")
naup.doy <- plot.zoop.doy(var.name = "NAUP.THOUS.M3") + 
  theme(legend.position = "none")
rotif.doy <- plot.zoop.doy(var.name = "ROTIF.THOUS.M3") + 
  theme(legend.position = "none")
daph.doy <- plot.zoop.doy(var.name = "DAPH.THOUS.M3") + 
  theme(legend.position = "none")
bosm.doy <- plot.zoop.doy(var.name = "BOSM.THOUS.M3") + 
  theme(legend.position = "none")
ceriod.doy <- plot.zoop.doy(var.name = "CERIOD.THOUS.M3") + 
  theme(legend.position = "none")
diaphan.doy <- plot.zoop.doy(var.name = "DIAPHAN.THOUS.M3") + 
  theme(legend.position = c(0.25, 0.75))



zoop <- cowplot::plot_grid(cyclo.doy, cala.doy, naup.doy, rotif.doy, daph.doy, 
                   bosm.doy, ceriod.doy, diaphan.doy)
zoop

#Figure S9
ggsave("./figures/FigureS9.jpeg", height = 10, width = 12)
```


# Bayesian peak timing - FIGURE S2 (and Code for other figures)
```{r}
pred.df <- data.frame(ice_off_anomaly = c(rep(early.anomaly, 201), rep(0, 201), 
                                          rep(late.anomaly, 201)),
                      JULIANDAY = seq(80, 280, by = 1), 
                      DNRID = "82016700", year_f = "2000") %>%
    mutate(row = row_number()) %>% 
    mutate(ice_off_f =  ifelse(ice_off_anomaly == early.anomaly, "Early", "Normal"),
           ice_off_f =  ifelse(ice_off_anomaly == late.anomaly, "Late", ice_off_f))

# Models to loop through
iters <- names(models)

timing.cis <- data.frame(group = character(0), 
                   numeric = numeric(0),
                   timing = character(0),
                   median = numeric(0),
                   lower.95 = numeric(0),
                   upper.95 = numeric(0),
                   lower.75 = numeric(0),
                   upper.75 = numeric(0))

for (i in 1:length(iters)) {
  model = models[[iters[i]]]
  
  # Use posterior dist of the mean to get posterior fitted values
  sims <- fitted_samples(model, exclude = c('s(DNRID)',  's(year_f)'),
                         data = pred.df, n = 1000, seed = 1024) |>
    left_join(pred.df |> select(row, ice_off_anomaly, JULIANDAY, ice_off_f), 
              by = join_by(row == row))
  
  # Get the peak timing when the ice off anomaly is big (ice-off happens late)
  early <- sims %>% filter(ice_off_anomaly == early.anomaly) %>% 
    group_by(draw) %>% slice_max(fitted)
  early.quant <- quantile(early$JULIANDAY, probs = c(.025,.975))
  early.quant.75 <- quantile(early$JULIANDAY, probs = c(.125, .875))
  early.median <- median(early$JULIANDAY)

  # Get the peak timing when the ice off anomaly is big (ice-off happens late)
  late <- sims %>% filter(ice_off_anomaly == late.anomaly) %>% 
    group_by(draw) %>% slice_max(fitted)
  late.quant <- quantile(late$JULIANDAY, probs = c(.025,.975))
  late.quant.75 <- quantile(late$JULIANDAY, probs = c(.125, .875))
  late.median <- median(late$JULIANDAY)
  
  # Get the peak timing when the ice off anomaly is normal (ice-off is average)
  average <- sims %>% filter(ice_off_anomaly == 0) %>% 
    group_by(draw) %>% slice_max(fitted)
  average.quant <- quantile(average$JULIANDAY, probs = c(.025,.975))
  average.quant.75 <- quantile(average$JULIANDAY, probs = c(.125, .875))
  average.median <- median(average$JULIANDAY)

  # Get the difference between peak timings
  diff.early <- early$JULIANDAY - average$JULIANDAY
  diff.earlymedian <- median(diff.early)
  diff.earlyquant <- quantile(diff.early, probs = c(.025,.975))
  diff.earlyquant.75 <- quantile(diff.early, probs = c(.125, .875))
  
  diff.late <- late$JULIANDAY - average$JULIANDAY
  diff.latemedian <- median(diff.late)
  diff.latequant <- quantile(diff.late, probs = c(.025,.975))
  diff.latequant.75 <- quantile(diff.late, probs = c(.125, .875))

  # Make new data frame to rbind to big data frame
  df <- data.frame(group = iters[[i]], 
                   numeric = i,
                   timing = c("Early", "Late", "Average", "Early Difference", "Late Difference"),
                   median = c(early.median, late.median, average.median, 
                              diff.earlymedian, diff.latemedian),
                   lower.95 = c(early.quant[1], late.quant[1], average.quant[1], 
                                diff.earlyquant[1], diff.latequant[1]),
                   upper.95 = c(early.quant[2], late.quant[2], average.quant[2],
                                diff.earlyquant[2], diff.latequant[2]),
                   lower.75 = c(early.quant.75[1], late.quant.75[1], average.quant.75[1],
                                diff.earlyquant.75[1], diff.latequant.75[1]),
                   upper.75 = c(early.quant.75[2], late.quant.75[2], average.quant.75[2],
                                diff.earlyquant.75[2], diff.latequant.75[2]))
  
  timing.cis <- rbind(timing.cis, df)
}


row.names(timing.cis) <- NULL


species.labels <- data.frame(variable = names(models), 
  axis.label = c("Cyclopoid Peak", "Calanoid Peak", 
                 "Nauplii Peak", "Rotifer Peak", "Daphnia Peak", 
                 "Bosmina Peak",  "Chydoridae Peak", "Ceriodaphnia Peak", 
                 "Diaphanosoma Peak"))

timing.cis.plot <- timing.cis %>%
  mutate(jit = ifelse(timing == "Early", -0.15, 0.15),
         jit = ifelse(timing == "Average", 0, jit),
         jit = ifelse(timing == "Early Difference", -0.15, jit)) %>%
  merge(y = species.labels, by.x = "group", by.y = "variable") %>%
  mutate(axis.label = factor(axis.label, 
                             levels = c(
    "Cyclopoid", "Calanoid",
    "Nauplii", "Rotifer", "Daphnia", "Bosmina",  
    "Chydoridae", "Ceriodaphnia", "Diaphanosoma")))

timing.cis.plot$timing <- factor(timing.cis.plot$timing, 
                                 levels = c("Early", "Average", "Late", 
                                            "Early Difference", "Late Difference"))


timing.cis.plot %>%
  filter(!grepl("Difference", timing)) %>%
  ggplot() + 
  geom_point(aes(x = as.Date(median, origin = as.Date("2018-01-01")), y = -1*(numeric + jit),
                 color = timing), size = 2) + 
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = as.Date(lower.95, origin = as.Date("2018-01-01")), 
                   xend = as.Date(upper.95, origin = as.Date("2018-01-01")), color = timing)) +
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = as.Date(lower.75, origin = as.Date("2018-01-01")), 
                   xend = as.Date(upper.75, origin = as.Date("2018-01-01")), color = timing), 
               linewidth = 1.5) +
  #facet_grid(group ~., switch = "y") +
  theme_classic() +
  labs(y = "",
       x = "Day Peak Density Occurs", color = "Ice-off Anomaly") +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        strip.text.y.left = element_text(angle = 0, size = 12, face = 2),
        plot.title = element_text(angle = 0, size = 14, face = 2),
        strip.placement = "outside",
        strip.background = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12)
        ) +
  scale_color_manual(values = c("#FF0000", "#000000", "#0000FF")) +
  scale_y_continuous(breaks = -1:-9, labels = levels(timing.cis.plot$axis.label)) +
  scale_x_date(date_labels = "%b")
  #scale_x_continuous(breaks = seq(100, 275, by = 25))

# Figure S2
ggsave("./figures/FigureS2.jpeg", height = 10, width = 10)
```


# FIGURE 2A - Bayesian peak timing - SUBSET - Calendar DOY
```{r}
#read in more data
timing.cis.wae <- read.csv("./data/wae_spawning_modeled.csv")
timing.cis.phyto <- read.csv("./data/phyto_modeled_peak.csv")

# y-axis plot labels
subset.labels = c("Chrysophyte","Dinoflagellate",
                  "Diatom",  
                  "Cyclopoid", "Calanoid",
                  "Daphnia", "Walleye \n Peak Spawning")

# groups to keep while filtering
groups_to_keep <- c("CHRYSOS", "DINOS","DIATOM",
                    "CALA.THOUS.M3", "CYCLO.THOUS.M3", "DAPH.THOUS.M3", 
                    "peak")

# x-axis plot labels
labels = c("April 1st", "May 1st",  
           "June 1st", "July 1st")

# bind data together
timing.cis.plot.all <- rbind(timing.cis.plot, timing.cis.wae, timing.cis.phyto) %>% 
  filter(group != "start")

plankton_subset_wae <- timing.cis.plot.all %>%
  filter(!grepl("Difference", timing)) %>%
  filter(group %in% groups_to_keep) %>%
  mutate(jit = ifelse(timing == "Early", -0.15, 0.15),
         jit = ifelse(timing == "Average", 0, jit),
         jit = ifelse(timing == "Early Difference", -0.15, jit)) %>%
  mutate(numeric = ifelse(group == "CHRYSOS", 1, numeric),
         numeric = ifelse(group == "DINOS", 2, numeric),
         numeric = ifelse(group == "DIATOMS", 3, numeric),
         numeric = ifelse(group == "CYCLO.THOUS.M3", 4, numeric),
         numeric = ifelse(group == "CALA.THOUS.M3", 5, numeric),
         numeric = ifelse(group == "DAPH.THOUS.M3", 6, numeric),
         numeric = ifelse(group == "peak", 7, numeric)) %>%
  ggplot() + 
  geom_point(aes(x = as.Date(median, origin = as.Date("2018-01-01")), y = -1*(numeric + jit),
                 color = timing), size = 2) + 
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = as.Date(lower.95, origin = as.Date("2018-01-01")), 
                   xend = as.Date(upper.95, origin = as.Date("2018-01-01")), color = timing)) +
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = as.Date(lower.75, origin = as.Date("2018-01-01")), 
                   xend = as.Date(upper.75, origin = as.Date("2018-01-01")), color = timing),
               linewidth = 1.5) +
  #facet_grid(group ~., switch = "y") +
  theme_classic() +
  labs(y = "",
       x = "Day Peak Density Occurs", color = "Ice-off Anomaly") +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        strip.text.y.left = element_text(angle = 0, size = 12, face = 2),
        plot.title = element_text(angle = 0, size = 14, face = 2),
        strip.placement = "outside",
        strip.background = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12)
        ) +
  theme(legend.position = c(.8, .1)) +
  scale_color_manual(values = c("#FF0000", "#000000",  "#0000FF")) +
  scale_y_continuous(breaks = -1:-7, labels = subset.labels) +
  scale_x_date(breaks = as.Date(c("2018-04-01", "2018-05-01",  
                                  "2018-06-01",  "2018-07-01")),
               label = labels)

plankton_subset_wae
# Figure 2A
ggsave("./figures/Figure2A.jpeg", height = 8, width = 10)
```


# FIGURE 2B - Bayesian peak timing - SUBSET - rate of change 
```{r}
# y-axis plot labels
subset.labels = c("Chrysophyte","Dinoflagellate",
                  "Diatom",  
                  "Cyclopoid", "Calanoid",
                  "Daphnia", "Walleye \n Peak Spawning")

# groups to keep while filtering
groups_to_keep <- c("CHRYSOS", "DINOS","DIATOM",
                    "CALA.THOUS.M3", "CYCLO.THOUS.M3", "DAPH.THOUS.M3", 
                    "peak")

rate_of_change <- timing.cis.plot.all %>%
  filter(grepl("Difference", timing)) %>%
  filter(group %in% c(groups_to_keep)) %>%
  mutate(jit = ifelse(timing == "Early", -0.15, 0.15),
         jit = ifelse(timing == "Average", 0, jit),
         jit = ifelse(timing == "Early Difference", -0.15, jit)) %>%
  mutate(numeric = ifelse(group == "CHRYSOS", 1, numeric),
         numeric = ifelse(group == "DINOS", 2, numeric),
         numeric = ifelse(group == "DIATOMS", 3, numeric),
         numeric = ifelse(group == "CYCLO.THOUS.M3", 4, numeric),
         numeric = ifelse(group == "CALA.THOUS.M3", 5, numeric),
         numeric = ifelse(group == "DAPH.THOUS.M3", 6, numeric),
         numeric = ifelse(group == "peak", 7, numeric)) %>%
  mutate(timing = ifelse(timing == "Early Difference", 
                         "Difference between early \nand average ice off", 
                         "Difference between late \nand average ice off")) %>%
  mutate(median = ifelse(timing == "Difference between early \nand average ice off", 
                         median/(-1*early.anomaly), median/late.anomaly),
         upper.95 = ifelse(timing == "Difference between early \nand average ice off",
                           upper.95/(-1*early.anomaly), upper.95/late.anomaly),
         lower.95 = ifelse(timing == "Difference between early \nand average ice off",
                           lower.95/(-1*early.anomaly), lower.95/late.anomaly),
         upper.75 = ifelse(timing == "Difference between early \nand average ice off",
                           upper.75/(-1*early.anomaly), upper.75/late.anomaly),
         lower.75 = ifelse(timing == "Difference between early \nand average ice off",
                           lower.75/(-1*early.anomaly), lower.75/late.anomaly)) %>%
  ggplot() + 
  geom_point(aes(x = median, y = -1*(numeric + jit),
                 color = timing), size = 2) + 
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = lower.95, 
                   xend = upper.95, color = timing)) +
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = lower.75, xend = upper.75, color = timing), linewidth = 1.5) +
  geom_vline(xintercept = 0, color = "black", linewidth = 1) +
  geom_vline(xintercept = -1, color = "grey", linewidth = .75) +
  geom_vline(xintercept = 1, color = "grey", linewidth = .75) +
  theme_classic() +
  labs(y = "",
       x = "Change in Days Event Occurs Per\n Day Change in Ice-Off", 
       color = "Ice-off Anomaly") +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        strip.text.y.left = element_text(angle = 0, size = 12, face = 2),
        plot.title = element_text(angle = 0, size = 14, face = 2),
        strip.placement = "outside",
        strip.background = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12)
        ) +
  scale_color_manual(values = c("#FF0000", "#0000FF")) +
  scale_y_continuous(breaks = -1:-7, labels = subset.labels) + theme(legend.position="none")

rate_of_change
# Figure 2B
#ggsave("./figures/Figure2B.jpeg", height = 8, width = 9)
```


# Figure 2 - Combining two figures
```{r}
cowplot::plot_grid(plankton_subset_wae, rate_of_change, labels = "AUTO")
ggsave("./figures/Figure2.jpeg", height = 10, width = 15)
```


# FIGURE 4 - Recreating Feiner et al. 2022 figure
```{r}
feiner.df <- data.frame(ice_off_anomaly = numeric(0),
                        JULIANDAY = numeric(0),
                        DNRID = numeric(0), year_f = numeric(0),
                        name = character(0), count = numeric(0)
                        )
anomaly = c(early.anomaly, 0, late.anomaly)

for (i in 1:3) {
  pred.df <- data.frame(ice_off_anomaly = anomaly[i],
                        JULIANDAY = seq(80, 280, by = 1), 
                        DNRID = "62001200", year_f = "2000") 
    
  fit <- predict.gam(models$CYCLO.THOUS.M3, pred.df,
                     unconditional = T, # Gives simultaneous
                     type = "response",
                     exclude = c('s(DNRID)', 's(year_f)'),
                     se.fit = T)
  pred.df$Cyclopoid = fit$fit
  
  fit.daph <- predict.gam(models$DAPH.THOUS.M3, pred.df,
                     unconditional = T, # Gives simultaneous
                     type = "response",
                     exclude = c('s(DNRID)', 's(year_f)'),
                     se.fit = T)
  
  pred.df$Daphnia = fit.daph$fit
  
  
  pred.df.long <- pred.df %>% pivot_longer(cols = Cyclopoid:Daphnia, values_to = "count")
  feiner.df = rbind(feiner.df, pred.df.long)
}

personal_theme = theme_classic() +
  theme(axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12)) +
  theme(plot.title = element_text(size = 16, hjust = 0.5))

early.anomaly.plot <- feiner.df %>%
  filter(ice_off_anomaly == early.anomaly) %>%
  ggplot() + 
  geom_vline(aes(xintercept = as.Date(104.26 + early.anomaly, origin = as.Date("2018-01-01")), 
                 color = "Ice-Off"), linewidth = 1.5) +
  geom_vline(aes(xintercept = as.Date(106.056329, origin = as.Date("2018-01-01")), 
                 color = "Walleye Spawning"), linewidth = 1) + 
  # Change value with how much Walleye spawning gets earlier
  geom_ribbon(aes(x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                  ymax = count, fill = name), ymin = 0, alpha = 0.3) + 
  coord_cartesian(xlim = as.Date(c("2018-03-31", "2018-10-15")), 
                  ylim = c(0, 40)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(title = "Early Ice-Off", 
       y = "Indivduals/L",
       x = "Month", fill = "", color = "") + 
  scale_color_manual(guide = "legend", 
                       breaks = c("Ice-Off", "Walleye Spawning"),
                       values = c("Ice-Off" = "Grey", "Walleye Spawning" = "Black")) +
  scale_fill_manual(guide = "legend", breaks = c("Cyclopoid", "Daphnia"), 
                    values = c("Cyclopoid" = "Brown", "Daphnia" = "green")) +
  scale_x_date(breaks = "1 month", date_labels = "%b") +
  personal_theme + theme(legend.position = "none")
  
early.anomaly.plot

average.anomaly.plot = feiner.df %>%
  filter(ice_off_anomaly == 0) %>%
  ggplot() + 
  geom_vline(aes(xintercept = as.Date(104.26, origin = as.Date("2018-01-01")), color = "Ice-Off"),
             linewidth = 1.5) +
  geom_vline(aes( xintercept = as.Date(113.902538, origin = as.Date("2018-01-01")), color = "Walleye Spawning"), 
             linewidth = 1) + 
  # Change value with how much Walleye spawning gets earlier
  geom_ribbon(aes(x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), ymax = count, fill = name), ymin = 0, alpha = 0.3) + 
  coord_cartesian(xlim = as.Date(c("2018-03-31", "2018-10-15")), ylim = c(0, 40)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(title = "Average Ice-Off", 
    y = "Indivduals/L",
    x = "Month", fill = "", color = "") + 
  scale_color_manual(guide = "legend", 
                       breaks = c("Ice-Off", "Walleye Spawning"),
                       values = c("Ice-Off" = "Grey", "Walleye Spawning" = "Black")) +
  scale_fill_manual(guide = "legend", breaks = c("Cyclopoid", "Daphnia"), 
                    values = c("Cyclopoid" = "Brown", "Daphnia" = "green")) +
  scale_x_date(breaks = "1 month", date_labels = "%b") +
  personal_theme + theme(legend.position = c(.8, .7))

average.anomaly.plot


late.anomaly.plot = feiner.df %>%
  filter(ice_off_anomaly == late.anomaly) %>%
  ggplot() + 
  geom_vline(aes(xintercept =  as.Date(104.26 + late.anomaly, origin = as.Date("2018-01-01")), 
                 color = "Ice-Off"), linewidth = 1.5) +
  geom_vline(aes(xintercept = as.Date(124.215987, origin = as.Date("2018-01-01")), 
                 # 10 = late anomaly for walleye
                 color = "Walleye Spawning"), 
             linewidth = 1) + 
  # Change value with how much Walleye spawning gets earlier
  geom_ribbon(aes(x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), ymax = count, fill = name), 
              ymin = 0, alpha = 0.3) + 
  coord_cartesian(xlim = as.Date(c("2018-03-31", "2018-10-15")), ylim = c(0, 40)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(title = "Late Ice-Off",
    y = "Indivduals/L",
    x = "Month", fill = "", color = "") + 
  scale_color_manual(guide = "legend", 
                       breaks = c("Ice-Off", "Walleye Spawning"),
                       values = c("Ice-Off" = "Grey", "Walleye Spawning" = "Black")) +
  scale_fill_manual(guide = "legend", breaks = c("Cyclopoid", "Daphnia"), 
                    values = c("Cyclopoid" = "Brown", "Daphnia" = "green")) +
  scale_x_date(breaks = "1 month", date_labels = "%b") + 
  personal_theme + theme(legend.position = "none") 
late.anomaly.plot

cowplot::plot_grid(early.anomaly.plot, average.anomaly.plot, late.anomaly.plot, 
                   nrow = 3, ncol = 1, labels = "AUTO")
# Figure 4
#ggsave("./figures/figure4.jpeg", height = 10, width = 10)
```


# Figure S5 - Bayesian peak timing - SUBSET - rate of change 
```{r}
subset.labels = c("Bosmina", "Calanoid", "Ceriodaphnia", "Chrysomonad", "Chydorus", "Cryptomonad", 
                  "Cyanobacteria", "Cyclopoid","Daphnia", "Diaphanosoma", "Diatom", "Dinoflagellate",
                  "Green-algae", "Nauplii", "Rotifera", "Walleye \n Peak Spawning")


all_rate_of_change <- timing.cis.plot.all %>%
  filter(grepl("Difference", timing)) %>%
  filter(!group %in% c("ZOOP.THOUS.M3", "ALL.CELLS")) %>%
  mutate(jit = ifelse(timing == "Early", -0.15, 0.15),
         jit = ifelse(timing == "Average", 0, jit),
         jit = ifelse(timing == "Early Difference", -0.15, jit),
         numeric = as.numeric(factor(group)),
         numeric = ifelse(group == "ROTIF.THOUS.M3", 15, numeric),
         numeric = ifelse(group == "peak", 16, numeric)) %>%
  mutate(timing = ifelse(timing == "Early Difference", 
                         "Early ice-off", 
                         "Late ice-off")) %>%
  mutate(median = ifelse(timing == "Early ice-off", 
                         median/(-1*early.anomaly), median/late.anomaly),
         upper.95 = ifelse(timing == "Early ice-off",
                           upper.95/(-1*early.anomaly), upper.95/late.anomaly),
         lower.95 = ifelse(timing == "Early ice-off",
                           lower.95/(-1*early.anomaly), lower.95/late.anomaly),
         upper.75 = ifelse(timing == "Early ice-off",
                           upper.75/(-1*early.anomaly), upper.75/late.anomaly),
         lower.75 = ifelse(timing == "Early ice-off",
                           lower.75/(-1*early.anomaly), lower.75/late.anomaly)) %>%
  ggplot() + 
  geom_point(aes(x = median, y = -1*(numeric + jit),
                 color = timing), size = 2) + 
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = lower.95, 
                   xend = upper.95, color = timing)) +
  geom_segment(aes(y = -1*(numeric + jit), yend = -1*(numeric + jit), 
                   x = lower.75, xend = upper.75, color = timing), linewidth = 1.5) +
  geom_vline(xintercept = 0, color = "black", linewidth = 1) +
  geom_vline(xintercept = -1, color = "grey", linewidth = .75) +
  geom_vline(xintercept = 1, color = "grey", linewidth = .75) +
  theme_classic() +
  labs(y = "",
       x = "Change in Days Event Occurs Per\n Day Change in Ice-Off", 
       color = "Ice-off Anomaly") +
  theme(panel.grid.major.x = element_line(),
        panel.grid.minor.x = element_line(),
        strip.text.y.left = element_text(angle = 0, size = 12, face = 2),
        plot.title = element_text(angle = 0, size = 14, face = 2),
        strip.placement = "outside",
        strip.background = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        legend.title = element_text(size = 14), 
        legend.text = element_text(size = 12)
        ) +
  scale_color_manual(values = c("#FF0000", "#0000FF")) +
  scale_y_continuous(breaks = -1:-16, labels = subset.labels) + theme(legend.position="none")

all_rate_of_change
# Figure S5
#ggsave("./figures/FigureS5.jpeg", height = 8, width = 9)
```

 
# See if zooplankton bloom size changes with ice-anomaly  
## Figure S7
```{r}
species.labels <- data.frame(variable = names(models), 
  axis.label = c("Cyclopoid", "Calanoid", 
                 "Nauplii", "Rotifer", "Daphnia", 
                 "Bosmina",  "Chydoridae", "Ceriodaphnia", 
                 "Diaphanosoma"))


bloom.size <- timing.cis.plot.all %>% 
  filter(!timing %in% c("Early Difference", "Late Difference")) %>% # filter out relative changes in timing
  filter(!group %in% c("peak")) %>% # filter out peak walleye spawning, not relevant
  filter(!group %in% c("CHRYSOS", "CRYPTOS", "CYANOS", "DIATOM", "DINOS", "GREEN")) %>%
  mutate(row = row_number(), 
         ice_off_anomaly = ifelse(timing == "Early", early.anomaly, 0), 
         ice_off_anomaly = ifelse(timing == "Late",  late.anomaly, ice_off_anomaly))

bloom.size.plot <- data.frame(group = character(0), ice_off_anomaly = numeric(0),
                     median = numeric(0), 
                     q2.5 = numeric(0), q97.5 = numeric(0),
                     q25 = numeric(0), q75 = numeric(0))

groups = unique(bloom.size$group)

for (i in 1:length(groups)) {
  model = models[[groups[i]]]
  
  group.df <- bloom.size %>% filter(group == groups[i])
  
  pred.df <- data.frame(JULIANDAY = 
                          c(
                          seq(group.df$median[1] - 3, group.df$median[1] + 3, by = 1 ),
                          seq(group.df$median[2] - 3, group.df$median[2] + 3, by = 1 ),
                          seq(group.df$median[3] - 3, group.df$median[3] + 3, by = 1 )), 
                        ice_off_anomaly = c(rep(group.df$ice_off_anomaly[1], 7),
                                            rep(group.df$ice_off_anomaly[2], 7),
                                            rep(group.df$ice_off_anomaly[3], 7)),
                        DNRID = "82016700", year_f = "2000",
                        TOW = 6) %>% 
    mutate(row = row_number()) 
  
  sims <- fitted_samples(model, exclude = c('s(DNRID)',  's(year_f)'),
                         newdata = pred.df, n = 1000, seed = 1024) |>
    left_join(pred.df |> select(row, ice_off_anomaly, JULIANDAY), 
              by = join_by(row == row))
  
  
  early.diff <- ((sims[sims$ice_off_anomaly == early.anomaly,]$fitted - 
    sims[sims$ice_off_anomaly == 0,]$fitted) / 
    sims[sims$ice_off_anomaly == 0,]$fitted) * 100
  late.diff <- ((sims[sims$ice_off_anomaly == late.anomaly,]$fitted - 
    sims[sims$ice_off_anomaly == 0,]$fitted) / 
      sims[sims$ice_off_anomaly == 0,]$fitted) * 100
  
  temp_toadd <- data.frame(group = groups[i], 
                     ice_off_anomaly = c("Early", "Late"),
                     median = c(median(early.diff), median(late.diff)),
                     q2.5 = c(quantile(early.diff, prob = c(0.025)),
                              quantile(late.diff, prob = c(0.025))),
                     q97.5 = c(quantile(early.diff, prob = c(0.975)),
                              quantile(late.diff, prob = c(0.975))),
                     q25 = c(quantile(early.diff, prob = c(0.75)),
                              quantile(late.diff, prob = c(0.75))),
                     q75 = c(quantile(early.diff, prob = c(0.25)),
                              quantile(late.diff, prob = c(0.25))))
  bloom.size.plot <- rbind(bloom.size.plot, temp_toadd)
  
}

bloom.size.plot %>%
  merge(species.labels, by.y = "variable", by.x = "group") %>%
  ggplot() + 
  geom_point(aes(y = median, x = ice_off_anomaly, color = ice_off_anomaly)) + 
  geom_segment(aes(y = q2.5, yend = q97.5, x = ice_off_anomaly, 
                   xend = ice_off_anomaly, color = ice_off_anomaly)) + 
  geom_segment(aes(y = q25, yend = q75, x = ice_off_anomaly, 
                   xend = ice_off_anomaly, color = ice_off_anomaly), 
               linewidth = 1.5) +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  facet_wrap(vars(axis.label), scales = "free") + 
  scale_color_manual(values = c("#FF0000", "#000000",  "#0000FF")) + 
  labs(y = "% Change in Abundance From Normal Ice-Off",
       x = "Ice-Off Timing", color = "Ice-Off Timing") +
  theme_classic() +
  theme(legend.position = c(.45, .935)) 

# Figure S7
#ggsave("./figures/FigureS7.jpeg", height = 8, width = 9)
```




# GRAVEYARD
### NOT USED IN PAPER ###

# DOY change function - BAYESIAN
```{r}
plot.zoop.doy.bayes = function(model = NA, var.name = NA, type = "plot", slice = 1, y.label = NA, 
                         early.anomaly = -17.52, late.anomaly = -14, start.date = 90, end.date = 280) {
  if (is.na(model)) {
    model <- models[[var.name]]
  }
  # Year and DNRID aren't used but are required for predict.gam
  length <- length(seq(start.date, end.date, by = 1))
  pred.df <- data.frame(ice_off_anomaly_abs = 
                          c(rep(early.anomaly, length), rep(0, length), rep(late.anomaly, length)),
                        ice_off_anomaly = 
                          c(rep(early.anomaly, length), rep(0, length), rep(late.anomaly, length)),
                        JULIANDAY = seq(start.date, end.date, by = 1), 
                        days_since_ice = seq(1, length),
                        towdepth = 10,
                        DNRID = "62001200", year_f = "2000") %>%
    mutate(row = row_number()) %>% 
    mutate(
           ice_off_f =  ifelse(ice_off_anomaly == early.anomaly, "Early", "Normal"),
           ice_off_f =  ifelse(ice_off_anomaly == late.anomaly, "Late", ice_off_f))

  
  
  
  fv <- fitted_values(model, data = pred.df, exclude = c('s(DNRID)',  's(year_f)'))
  fs <- fitted_samples(model, data = pred.df, n = 20, seed = 1024,
                       exclude = c('s(DNRID)',  's(year_f)')) |>
    left_join(pred.df |> select(row, ice_off_anomaly, JULIANDAY), 
              by = join_by(row == row)) %>%
    drop_na()
  fit <- predict.gam(model, pred.df,
                     unconditional = T, # Gives simultaneous
                     type = "response",
                     exclude = c('s(DNRID)', 
                                's(year_f)'),
                     se.fit = T)
  pred.df$predictions = fit$fit
  pred.df$se = fit$se.fit
  
  if (type == "plot") {
    y.label <- species.labels %>% filter(variable == var.name) %>% 
        select(axis.label) %>% as.character()
    plot <- ggplot() +
      #geom_line(data = fs, 
      #          aes(group = draw, 
      #              x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")),
      #              y = fitted, colour = ice_off_f), alpha = 0.4) +
      geom_line(data = pred.df, aes(y = predictions, 
                    x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                    color = ice_off_f), lwd = 2) +
      geom_ribbon(data = fv, 
                  aes(x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")),
                      y = fitted, ymin = lower, ymax = upper, 
                      fill = ice_off_f), alpha = 0.3) +
      theme_classic() +
      scale_x_date(date_breaks = "months" , date_labels = "%b") + 
      labs(y = paste0(y.label), x = "Julian Day", 
           color = "Ice-Off", fill = "Ice-Off") +
      theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 16))
    
    return(plot)
  } # End plot if statement
  
  if (type == "max.date") {
    max.date <- pred.df %>% group_by(ice_off_anomaly) %>% slice_max(predictions, n = slice) %>% 
      mutate(zoop = var.name)
    max.date$predictions <- predict(model, newdata = max.date, 
                                    exclude = c("s(DNRID)", "s(year_f)"), 
                                    type = "response")
    max.date$se <- predict(model, newdata = max.date, exclude = c("s(DNRID)", "s(year_f)"), 
                           type = "response", se.fit = T)$se.fit
    
    return(max.date)
  } # End prediction if statement
}
```

# Plot DOY change - CIs
```{r}
hist(temp$JULIANDAY) # Approx 125-275 for peak sampling, look at 100 - 300
min(temp$JULIANDAY)

# Thoughts to do - Change x-axis to Months
species.labels <- data.frame(variable = names(models), 
           axis.label = c("Zooplankton Density","Cyclopoid Density", "Calanoid Density", 
                          "Nauplii Density", "Rotifer Density", 
                          "Daphnia Density", "Bosmina Density", 
                          "Chydoridae Density", "Ceriodaphnia Density", 
                          "Diaphanosoma Density"
                          ))


cyclo.doy <- plot.zoop.doy.bayes(var.name = "CYCLO.THOUS.M3") + theme(legend.position="none")
#cyclo.doy 
#ggsave("./figures/cyclo_doy.jpeg", height = 10, width = 10)
cala.doy <- plot.zoop.doy.bayes(var.name = "CALA.THOUS.M3") + theme(legend.position="none")
naup.doy <- plot.zoop.doy.bayes(var.name = "NAUP.THOUS.M3") + theme(legend.position="none")
rotif.doy <- plot.zoop.doy.bayes(var.name = "ROTIF.THOUS.M3") + theme(legend.position="none")
daph.doy <- plot.zoop.doy.bayes(var.name = "DAPH.THOUS.M3") + theme(legend.position="none")
bosm.doy <- plot.zoop.doy.bayes(var.name = "BOSM.THOUS.M3") + theme(legend.position="none")
ceriod.doy <- plot.zoop.doy.bayes(var.name = "CERIOD.THOUS.M3") + theme(legend.position="none")
diaphan.doy <- plot.zoop.doy.bayes(var.name = "DIAPHAN.THOUS.M3") + 
  theme(legend.position = c(0.25, 0.75))
zoop.doy <- plot.zoop.doy.bayes(var.name = "ZOOP.THOUS.M3") + theme(legend.position="none")


zoop <- cowplot::plot_grid(cyclo.doy, cala.doy, naup.doy, rotif.doy, daph.doy, 
                   bosm.doy, ceriod.doy, diaphan.doy, zoop.doy)

title <- ggdraw() + 
  draw_label(
    "Effects of Anomalous Ice-Off on Zooplankton Densities Over the Year",
    fontface = 'bold',
    size = 23,
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  #title, 
  zoop,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

#ggsave("./figures/all_zoop_doy.bayes.jpeg", height = 10, width = 12)
```

# Plot Anomaly results
```{r}
plot.zoop.anomaly = function(var.name){
  
  model <- models[[var.name]]
  
  sm <- smooth_estimates(model)
  sm <- sm %>%
    add_constant(coef(model)["(Intercept)"]) %>% 
    add_confint() %>%
    transform_fun(inv_link(model)) %>% 
    mutate(lower_ci = exp(lower_ci),
           upper_ci = exp(upper_ci))
  
  temp_residuals <- temp %>% add_partial_residuals(model) %>%
    add_constant(coef(model)["(Intercept)"], column = 26) %>%
    transform_fun(inv_link(model), column = 26)
  
  # Creat upper limit for ggplot (1 or 2 really large residuals)
  upper.limit <- quantile(temp_residuals$`s(ice_off_anomaly)`, 0.975)
  
  fig <- sm %>% filter(smooth == "s(ice_off_anomaly)" ) %>%
    ggplot(aes(x = ice_off_anomaly, y = est)) +
    geom_point(aes(x = ice_off_anomaly, y = `s(ice_off_anomaly)`), 
               alpha = 0.1,
               data = temp_residuals) +
    geom_line(lwd = 1.5) +
    geom_ribbon(aes(ymin = lower_ci , ymax = upper_ci), alpha = 0.3) +
    ylim(0, upper.limit) +
    theme_classic() +
    labs(y = var.name, x = "Ice-Off Anomaly") +
    theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 16))
  
  return(fig)
}

cyclo <- plot.zoop.anomaly("CYCLO.THOUS.M3")
cyclo
cala <- plot.zoop.anomaly("CALA.THOUS.M3")
cala
naup <- plot.zoop.anomaly("NAUP.THOUS.M3")
naup
rotif <- plot.zoop.anomaly("ROTIF.THOUS.M3")
rotif
daph <- plot.zoop.anomaly("DAPH.THOUS.M3")
daph
bosm <- plot.zoop.anomaly("BOSM.THOUS.M3")
ceriod <- plot.zoop.anomaly("CERIOD.THOUS.M3")
diaphan <- plot.zoop.anomaly("DIAPHAN.THOUS.M3")
lepto <- plot.zoop.anomaly("LEPTO.THOUS.M3")

cowplot::plot_grid(cyclo, cala, naup, rotif, daph, 
                   bosm, ceriod, diaphan, 
                   labels = "AUTO")
#ggsave("./figures/all_zoop.jpeg", height = 10, width = 15)
```

# Can I do it in one model
```{r}
long <- temp %>% 
  pivot_longer(cols = CYCLO.THOUS.M3:DIAPHAN.THOUS.M3,
               values_to = "values",
               names_to = "taxa") %>%
  mutate(taxa = as.factor(taxa)
         )

zoop.gam <- gam(values ~ 
                   te(JULIANDAY, ice_off_anomaly, m = 2, bs = "tp") + 
                   t2(JULIANDAY, ice_off_anomaly, taxa, 
                      m = 2, bs = c("tp", "tp", "re")) +
                   s(taxa, DNRID, bs = "re") + s(taxa, year_f, bs = "re"), 
                 method = "fREML", select = T,
                 data = long, family = tw(link = "log"))
summary(zoop.gam)
appraise(zoop.gam)
draw(zoop.gam, select = 2)
write_rds(zoop.gam, "./models/multispecies.zoop.model.rds")
```

# Alternative plotting
```{r}
groups <- unique(long$taxa)
n = length(groups)
pred.df <- data.frame(ice_off_anomaly = 
                        c(rep(early.anomaly, 186*n), rep(0, 186*n), rep(late.anomaly, 186*n)),
                      JULIANDAY = seq(90, 275, by = 1), 
                      taxa = rep(groups, each = 186),
                      DNRID = "62001300", year_f = "2010") 
  
fit <- predict.gam(zoop.gam, pred.df,
                     unconditional = T, # Gives simultaneous
                     type = "response",
                     exclude = c('s(DNRID)', 
                                's(year_f)'),
                     se.fit = T)

pred.df$predictions = fit$fit
pred.df$se = fit$se.fit

pred.df %>%
      mutate(ice_off_anomaly = as.factor(ice_off_anomaly),
             ice_off_descriptor = 
               ifelse(ice_off_anomaly == early.anomaly, "Early", "Normal"),
             ice_off_descriptor = 
               ifelse(ice_off_anomaly == late.anomaly, "Late", ice_off_descriptor)) %>%
      ggplot(aes(y = predictions, x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                 color = ice_off_anomaly)) +
      #geom_point() +
      geom_line(aes(y = predictions, x = as.Date(JULIANDAY, origin = as.Date("2018-01-01")), 
                    color = ice_off_descriptor), lwd = 2) +
      #geom_ribbon(aes(ymin = predictions - se, ymax = predictions + se, 
      #                fill = ice_off_descriptor, color = ice_off_descriptor), 
      #            lwd = 0.5, alpha = 0.05) +
      facet_wrap(vars(taxa), scales = "free") +
      theme_classic() +
      scale_x_date(date_breaks = "months" , date_labels = "%b") + 
      labs(y = paste0("Zooplankton density"), x = "Julian Day", 
           color = "Ice-Off", fill = "Ice-Off") +
      theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 16))
```




